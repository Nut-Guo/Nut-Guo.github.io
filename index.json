[{"categories":["misc"],"content":"在Manjaro下运行一个Ubuntu 在物理机上安装了两个Linux发行版，以应对不同的应用需求，但相互切换频繁操作繁琐，于是开始折腾如何在已经启动一个Linux安装之后使用安装在另一个分区的Linux发行版。 ","date":"2020-10-19","objectID":"/systemd-nspawn/:0:0","tags":["Manjaro"],"title":"在Manjaro下运行一个Ubuntu","uri":"/systemd-nspawn/"},{"categories":["misc"],"content":"1 方案一：修改fstab挂载分区 直接打开Manjaro后，在文件管理器中可以直接打开Ubuntu所在的分区，但是由于每次动态挂载回导致路径不固定，不方便于后续的折腾。可在/etc/fstab文件中添加对于Ubuntu所在分区的挂载，将其挂载到固定的位置。 使用lsblk -f命令找到相应分区的UUID，在/etc/fstab文件中添加挂载的配置条目。 UUID=\u003cUUID\u003e /ubuntu ext4 defaults,noatime 0 1 挂载后，部分软件已经可以直接使用了，例如基于Java的Vivado，在挂载之后可以直接在其安装目录下运行命令，打开图形界面进行使用。但这是因为Vivado是跑在Java虚拟机中的，本机安装了Java之后不需要额外的依赖环境。尝试执行ELF格式的软件时，将会发现部分软件缺少依赖的动态库而无法直接运行，这时仅挂载目录的方案就不能完全解决问题了。 ","date":"2020-10-19","objectID":"/systemd-nspawn/:1:0","tags":["Manjaro"],"title":"在Manjaro下运行一个Ubuntu","uri":"/systemd-nspawn/"},{"categories":["misc"],"content":"2 方案二：mount+chroot 将主机的/proc目录/sys目录/run/udev目录/dev目录绑定到Ubuntu文件系统的相应位置，注意由于这些目录均为虚拟文件目录，不必担心这样的绑定破坏了Ubuntu文件系统的完整性。 mount -t proc /proc /ubuntu/proc mount --rbind /dev /ubuntu/dev mount --bind /run /ubuntu/run mount --bind /tmp /ubuntu/tmp 在host操作系统中打开一个新的Xserver并监听，注意需要先使用xhost允许来自localhost的连接。 sudo xhost +local: sudo X -quiet -nolisten tcp -noreset :1 vt2 chroot到Ubuntu操作系统中之后指定使用的DISPLAY端口，即可在相应的tty中执行GUI应用程序。 例如：DISPLAY=:1 firefox。或者也可以直接指定DISPLAY=:0，使用主机的桌面环境。 这一方法可以支撑ELF格式的软件的执行，但问题在于可能没有办法使用网络。 ","date":"2020-10-19","objectID":"/systemd-nspawn/:2:0","tags":["Manjaro"],"title":"在Manjaro下运行一个Ubuntu","uri":"/systemd-nspawn/"},{"categories":["misc"],"content":"3 方案三：systemd-nspawn 直接使用systemd-nspawn指令，可用于在一个轻量命名空间容器中运行命令或操作系统。它比 chroot 更强大在于它完全虚拟化了文件系统层次结构、进程树、各种 IPC 子系统以及主机和域名。 通过该指令可直接在container中运行一个受限的Ubuntu操作系统，通过systemd-nspawn，可以直接在另一个tty中打开一个ubuntu的gnome桌面。 将操作封装为函数添加到.zshrc以便重用。 function spawn_ubuntu() { sudo xhost +local: sudo X -quiet -nolisten tcp -noreset :1 vt2 \u003e\u003e /dev/null 2\u003e\u00261 \u0026#打开Xserver sudo systemd-nspawn -bD /ubuntu \\ --bind=/lib/modules \\ --bind-ro=/tmp/.X11-unix \\ --bind=/mnt #非必要 } 在终端中直接输入spawn_ubuntu便可直接使用Ubuntu了，终端中登录后使用 DISPLAY=:1 gnome-session 在tty2中打开gnome桌面环境，通过Ctrl + Alt + \u003ctty_num\u003e在不同的tty之间进行切换。 ","date":"2020-10-19","objectID":"/systemd-nspawn/:3:0","tags":["Manjaro"],"title":"在Manjaro下运行一个Ubuntu","uri":"/systemd-nspawn/"},{"categories":["misc"],"content":"参考文献 fstab wiki Chroot with second desktop environment - Howto and notes systemd-nspawn wiki ","date":"2020-10-19","objectID":"/systemd-nspawn/:4:0","tags":["Manjaro"],"title":"在Manjaro下运行一个Ubuntu","uri":"/systemd-nspawn/"},{"categories":["OS"],"content":"RISC-V 特权级切换 UCAS的计算机专业操作系统实验中要求实现sleep系统调用，涉及到RISC-V的一些细节，需要阅读手册理解该指令集下的工作机制，在此做一总结。 ","date":"2020-10-18","objectID":"/riscv-syscall/:0:0","tags":["Lab"],"title":"RISC-V 特权级切换","uri":"/riscv-syscall/"},{"categories":["OS"],"content":"1 切换运行模式至用户态 实验手册的注意事项中给出了如下提示： RISC-V 在所有特全级下都用ecall执行系统调用。Supervisor态ecall会触发machine态的例外，user态的ecall会触发supervisor态的中断。所以大家务必注意，要让USER模式的进程/线程运行在用户态。 Supervisor模式和User模式的切换是后续顺利实验的关键。《RISC-V手册》第10章关于特权架构的介绍中提到： S 模式有几个异常处理 CSR:sepc、stvec、scause、sscratch、stval 和 sstatus,它们执行与 M 模式 CSR 相同的功能。监管者异常返回指令 sret 与 mret 的行为相同,但它作用于 S 模式的异常处理 CSR,而不是 M 模式的 CSR。S 模式处理例外的行为已和 M 模式非常相似。如果 hart 接受了异常并且把它委派给了S 模式,则硬件会原子地经历几个类似的状态转换,其中用到了 S 模式而不是 M 模式的CSR: 发生例外的指令的 PC 被存入 sepc,且 PC 被设置为 stvec。 scause 根据异常类型设置,stval 被设置成出错的地址或者其它特定异常的信息字。 把 sstatus CSR 中的 SIE 置零,屏蔽中断,且 SIE 之前的值被保存在 SPIE 中。 发生例外时的权限模式被保存在 sstatus 的 SPP 域,然后设置当前模式为 S 模式。 这一部分描述了从User模式进入到Supervisor模式的过程中硬件的处理机制，从Supervisor模式返回User模式的过程手册中没有直接介绍，但可以通过对mret的介绍了解其工作方式。 处理程序用 mret 指令(M 模式特有的指令)返回。mret 将 PC 设置为 mepc,通过将 mstatus 的 MPIE 域复制到MIE 来恢复之前的中断使能设置,并将权限模式设置为 mstatus 的 MPP 域中的值。 这基本是前一段中描述的逆操作。 显然想要将运行模式切换到用户态，需要的指令就是sret了。 在执行sret之前，需要准备好sepc，sstatus寄存器，这一部分寄存器应当在恢复上下文时完成，需要特别关注sstatus的SPIE位以及SPP位，这为初始化PCB时的设计给出了提示。具体实现可通过阅读手册中对于sret指令的说明得到一些提示。 ","date":"2020-10-18","objectID":"/riscv-syscall/:1:0","tags":["Lab"],"title":"RISC-V 特权级切换","uri":"/riscv-syscall/"},{"categories":["OS"],"content":"2 系统调用 ecall指令我们在Project 1的SBI_CALL中见到过，当时的用法是通过寄存器传参后调用sbi函数，这是在Supervisor模式下的行为。如果读者在没有完成上下文切换的时候尝试过使用ecall指令触发中断，并仔细调试的话，预期触发中断的地方很可能直接执行了一个sbi函数。而若已经正确切换到User模式，将会跳转到stvec继续执行，异常类型存放在scause中，stval 被设置成出错的地址或者其它特定异常的信息字。后续系统调用的实现就很简单了，不再赘述。 祝大家实验顺利。 ","date":"2020-10-18","objectID":"/riscv-syscall/:2:0","tags":["Lab"],"title":"RISC-V 特权级切换","uri":"/riscv-syscall/"},{"categories":["OS"],"content":"3 参考文献 RISC-V 手册 P2-Guidebook-RISCV ","date":"2020-10-18","objectID":"/riscv-syscall/:3:0","tags":["Lab"],"title":"RISC-V 特权级切换","uri":"/riscv-syscall/"},{"categories":["OS"],"content":"操作系统实验环境配置 操作系统实验中，利用qemu运行RISCV架构下的操作系统，gdb远程调试。利用vscode给gdb提供图形界面的支持可以极大的改善调试体验。 ","date":"2020-10-17","objectID":"/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/:0:0","tags":["Lab"],"title":"内核调试环境配置","uri":"/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"},{"categories":["OS"],"content":"1 安装Native Debug插件 Native DebugNative Debug \" Native Debug ","date":"2020-10-17","objectID":"/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/:1:0","tags":["Lab"],"title":"内核调试环境配置","uri":"/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"},{"categories":["OS"],"content":"2 配置Lauch.json { \"version\": \"0.2.0\", \"configurations\": [ { \"type\": \"gdb\", \"request\": \"attach\", \"name\": \"Attach to QEMU\", //替换为自己的可执行文件路径 \"executable\": \"${workspaceFolder}/prj2/main\", //将端口替换为当前实验中qemu打开的端口，例如xv6习惯于使用26000 \"target\": \"localhost:1234\", \"remote\": true, \"cwd\": \"${workspaceRoot}\", //替换为相应的gdb可执行文件的地址 \"gdbpath\": \"/riscv64-linux/bin/riscv64-unknown-linux-gnu-gdb\", \"autorun\": [ //添加其他需要的文件提供调试信息 \"add-symbol-file ${workspaceFolder}/prj2/bootblock\", //在入口函数下断点 \"b _start\" ] }, ] } ","date":"2020-10-17","objectID":"/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/:2:0","tags":["Lab"],"title":"内核调试环境配置","uri":"/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"},{"categories":["OS"],"content":"3 愉快调试 在终端中启动qemu后，F5打开调试器，程序将自动停止在设定的断点处。 debugdebug \" debug Tips: 使用侧边栏调试窗口中的Call Stack查看调用栈 Debug Console中照常使用gdb打印信息 在.gdbinit中自定义宏，打印信息,例如: define plist set $hd = (list_node_t*)\u0026ready_queue set $nd = ready_queue-\u003enext while($nd != $hd) p/x $nd set $nd = ((list_node_t*)$nd)-\u003enext end end define pcur printf \"current_running-\u003ekernel_sp= %lx\",current_running-\u003ekernel_sp printf \"current_running-\u003euser_sp= %lx\",current_running-\u003euser_sp printf \"context:\\n\" x/36gx current_running-\u003ekernel_sp end 示例： pcurpcur \" pcur 祝大家调试愉快。 ","date":"2020-10-17","objectID":"/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/:3:0","tags":["Lab"],"title":"内核调试环境配置","uri":"/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"},{"categories":["环境配置"],"content":"Configure manjaro ","date":"2020-09-01","objectID":"/manjaro-configure/:0:0","tags":["Manjaro"],"title":"Manjaro","uri":"/manjaro-configure/"},{"categories":["环境配置"],"content":"Change sources ","date":"2020-09-01","objectID":"/manjaro-configure/:1:0","tags":["Manjaro"],"title":"Manjaro","uri":"/manjaro-configure/"},{"categories":["环境配置"],"content":"rank mirrors sudo pacman-mirrors -i -c China -m rank sudo pacman -Syu ","date":"2020-09-01","objectID":"/manjaro-configure/:1:1","tags":["Manjaro"],"title":"Manjaro","uri":"/manjaro-configure/"},{"categories":["环境配置"],"content":"change the gem source gem sources --add https://mirrors.tuna.tsinghua.edu.cn/rubygems/ --remove https://rubygems.org/ ","date":"2020-09-01","objectID":"/manjaro-configure/:1:2","tags":["Manjaro"],"title":"Manjaro","uri":"/manjaro-configure/"},{"categories":["环境配置"],"content":"change the npm source npm install -g nrm // 全局安装nrm模块 nrm ls // 显示所有可用的源 nrm use taobao // 切换到淘宝源： ","date":"2020-09-01","objectID":"/manjaro-configure/:2:0","tags":["Manjaro"],"title":"Manjaro","uri":"/manjaro-configure/"},{"categories":["环境配置"],"content":"change the bundle source bundle config mirror.https://rubygems.org https://mirrors.tuna.tsinghua.edu.cn/rubygems ","date":"2020-09-01","objectID":"/manjaro-configure/:3:0","tags":["Manjaro"],"title":"Manjaro","uri":"/manjaro-configure/"},{"categories":["环境配置"],"content":"add archlinuxcn and arch4edu #edit /etc/pacman.conf #append the following content [archlinuxcn] SigLevel = Optional TrustedOnly Server = http://mirrors.ustc.edu.cn/archlinuxcn/$arch [arch4edu] SigLevel = Never Server = http://mirrors.tuna.tsinghua.edu.cn/arch4edu/$arch add the archlinuxcn-keyring sudo pacman -S archlinuxcn-keyring sudo pacman -Syu ","date":"2020-09-01","objectID":"/manjaro-configure/:3:1","tags":["Manjaro"],"title":"Manjaro","uri":"/manjaro-configure/"},{"categories":["环境配置"],"content":"add blackarch # Run https://blackarch.org/strap.sh as root and follow the instructions. $ curl -O https://blackarch.org/strap.sh # The SHA1 sum should match: 9f770789df3b7803105e5fbc19212889674cd503 strap.sh $ sha1sum strap.sh # Set execute bit $ chmod +x strap.sh # Run strap.sh $ sudo ./strap.sh #change the source #edit the /etc/pacman.conf [blackarch] SigLevel = Optional TrustAll Server = https://mirrors.ustc.edu.cn/blackarch/$repo/os/$arch # add keyring first ","date":"2020-09-01","objectID":"/manjaro-configure/:3:2","tags":["Manjaro"],"title":"Manjaro","uri":"/manjaro-configure/"},{"categories":["环境配置"],"content":"Necessary software zsh sudo pacman -S manjaro-zsh-config chsh -s /bin/zsh yay sudo pacman -S yay chrome typora nvim code anaconda goldendict sudo pacman -S google-chrome typora code goldendict rime-pinyin sudo pacman -S fctix-rime kcm-fcitx fcitx-gtk2 fcitx-gtk3#need to log out gdb\u0026radare2\u0026pwntools sudo pacman -S pwndbg peda gef radare2 ghidra sudo pacman -S ghidra vmware sudo pacman -S vmware-workstation Remember to install the right linux-headers before using vmware, and start the networking. systemctl start vmware-networks.service systemctl enable vmware-networks.service metasploit sudo pacman -S msfdb metasploit ","date":"2020-09-01","objectID":"/manjaro-configure/:4:0","tags":["Manjaro"],"title":"Manjaro","uri":"/manjaro-configure/"},{"categories":["环境配置"],"content":"Configure the environment asystem time synchronize sudo timedatectl set-local-rtc true mount the windows partion UUID=0CB47F55B47F406E /mnt/C ntfs-3g defaults 0 0 UUID=585245C85245AB96 /mnt/D ntfs-3g defaults 0 0 ","date":"2020-09-01","objectID":"/manjaro-configure/:5:0","tags":["Manjaro"],"title":"Manjaro","uri":"/manjaro-configure/"},{"categories":["环境配置"],"content":"Backup backup with clonezilla restore the grub ","date":"2020-09-01","objectID":"/manjaro-configure/:6:0","tags":["Manjaro"],"title":"Manjaro","uri":"/manjaro-configure/"}]